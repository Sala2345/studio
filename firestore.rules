/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for customer data and design requests,
 *              while allowing public read access to file metadata.
 *
 * Data Structure:
 * - /customers/{customerId}: Stores customer information. Only the authenticated user matching the customerId can read or write.
 * - /customers/{customerId}/designRequests/{designRequestId}: Stores design requests.
 *   Only the authenticated user matching the customerId can read or write.
 * - /files/{fileId}: Stores metadata about uploaded files. Any authenticated user can create a file.
 *   Only the user associated with the design request can update or delete. Read access is public.
 *
 * Key Security Decisions:
 * - Disallows listing all customers.
 * - Enforces ownership for customer and design request data using path-based authorization.
 * - Allows public read access to file metadata.
 * - Requires user authentication for all write operations.
 *
 * Denormalization for Authorization:
 * - DesignRequest documents store the customerId, enabling direct authorization checks without requiring a get() on the parent Customer document.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure customer profiles. Only the authenticated user matching the customerId can read or write.
     * @path /customers/{customerId}
     * @allow (create, update, delete) if request.auth.uid == customerId
     * @allow (get, list) if request.auth.uid == customerId
     * @deny (create) if request.auth.uid != customerId
     * @deny (get, list) if request.auth.uid != customerId
     * @principle Enforces document ownership for all operations.
     */
    match /customers/{customerId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get, list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isOwner(customerId) && resource != null;
      allow delete: if isOwner(customerId) && resource != null;
    }

    /**
     * @description Secure design requests under a customer.
     * @path /customers/{customerId}/designRequests/{designRequestId}
     * @allow (create, update, delete) if request.auth.uid == customerId
     * @allow (get, list) if request.auth.uid == customerId
     * @deny (create) if request.auth.uid != customerId
     * @deny (get, list) if request.auth.uid != customerId
     * @principle Enforces document ownership for all operations.
     */
    match /customers/{customerId}/designRequests/{designRequestId} {
      function isOwner(customerId) {
        return request.auth.uid == customerId;
      }

      allow get, list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isOwner(customerId) && resource != null;
      allow delete: if isOwner(customerId) && resource != null;
    }

    /**
     * @description Manages file metadata. Public read, owner-only write.
     * @path /files/{fileId}
     * @allow (get, list) if true
     * @allow (create) if isSignedIn()
     * @deny (update, delete) if true
     * @principle Allows public read access but restricts write access to authenticated users.
     */
    match /files/{fileId} {
      allow get, list: if true;
      allow create: if request.auth != null;
      allow update: if false;
      allow delete: if false;
    }
  }
}